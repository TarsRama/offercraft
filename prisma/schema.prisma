// OfferCraft Database Schema
// Multi-tenant SaaS for professional offer/proposal management

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ===========================================
// PLATFORM LEVEL (Super Admin)
// ===========================================

enum PlatformRole {
  SUPER_ADMIN
  PLATFORM_ADMIN
  SUPPORT
}

model PlatformAdmin {
  id        String       @id @default(cuid())
  email     String       @unique
  password  String
  firstName String?
  lastName  String?
  role      PlatformRole @default(PLATFORM_ADMIN)
  isActive  Boolean      @default(true)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  @@map("platform_admins")
}

// ===========================================
// TENANT LEVEL
// ===========================================

enum SubscriptionTier {
  FREE
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  TRIALING
  PAST_DUE
  CANCELED
  PAUSED
}

model Tenant {
  id                 String             @id @default(cuid())
  name               String
  slug               String             @unique
  logo               String?
  primaryColor       String             @default("#3B82F6")
  secondaryColor     String             @default("#1E40AF")
  settings           Json               @default("{}")
  subscriptionTier   SubscriptionTier   @default(FREE)
  subscriptionStatus SubscriptionStatus @default(TRIALING)
  trialEndsAt        DateTime?
  billingEmail       String?
  vatNumber          String?
  address            String?
  phone              String?
  website            String?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  // Relations
  users            User[]
  clients          Client[]
  offers           Offer[]
  articleTemplates ArticleTemplate[]
  offerTemplates   OfferTemplate[]
  emailTemplates   EmailTemplate[]

  @@map("tenants")
}

// ===========================================
// USER (Tenant Users)
// ===========================================

enum UserRole {
  TENANT_ADMIN
  MANAGER
  USER
  VIEWER
}

model User {
  id            String    @id @default(cuid())
  tenantId      String
  email         String
  emailVerified DateTime?
  password      String
  firstName     String
  lastName      String
  avatar        String?
  phone         String?
  role          UserRole  @default(USER)
  isActive      Boolean   @default(true)
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  offers        Offer[]        @relation("CreatedOffers")
  offerVersions OfferVersion[]
  notifications Notification[]
  accounts      Account[]
  sessions      Session[]

  @@unique([tenantId, email])
  @@index([tenantId])
  @@map("users")
}

// ===========================================
// NEXTAUTH MODELS
// ===========================================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ===========================================
// CLIENT MANAGEMENT
// ===========================================

enum ClientStatus {
  LEAD
  ACTIVE
  INACTIVE
}

model Client {
  id          String       @id @default(cuid())
  tenantId    String
  companyName String
  vatNumber   String?
  email       String?
  phone       String?
  website     String?
  notes       String?      @db.Text
  tags        String[]
  status      ClientStatus @default(LEAD)
  latitude    Float?
  longitude   Float?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Relations
  tenant    Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  addresses ClientAddress[]
  contacts  ClientContact[]
  offers    Offer[]

  @@index([tenantId])
  @@index([status])
  @@map("clients")
}

model ClientContact {
  id        String   @id @default(cuid())
  clientId  String
  name      String
  email     String?
  phone     String?
  position  String?
  isPrimary Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@map("client_contacts")
}

enum AddressType {
  BILLING
  SHIPPING
  PROJECT
}

model ClientAddress {
  id        String      @id @default(cuid())
  clientId  String
  street    String
  city      String
  state     String?
  country   String
  zipCode   String?
  type      AddressType @default(BILLING)
  isPrimary Boolean     @default(false)
  latitude  Float?
  longitude Float?
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  // Relations
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@map("client_addresses")
}

// ===========================================
// OFFER MANAGEMENT
// ===========================================

enum OfferStatus {
  DRAFT
  PENDING_APPROVAL
  SENT
  VIEWED
  ACCEPTED
  REJECTED
  WON
  LOST
  EXPIRED
}

model Offer {
  id                 String      @id @default(cuid())
  tenantId           String
  clientId           String
  createdById        String
  offerNumber        String
  title              String
  status             OfferStatus @default(DRAFT)
  language           String      @default("en")
  currency           String      @default("EUR")
  validUntil         DateTime?
  coverPage          Json?
  executiveSummary   String?     @db.Text
  termsAndConditions String?     @db.Text
  internalNotes      String?     @db.Text
  subtotal           Decimal     @default(0) @db.Decimal(12, 2)
  discountTotal      Decimal     @default(0) @db.Decimal(12, 2)
  vatTotal           Decimal     @default(0) @db.Decimal(12, 2)
  total              Decimal     @default(0) @db.Decimal(12, 2)
  sentAt             DateTime?
  viewedAt           DateTime?
  acceptedAt         DateTime?
  rejectedAt         DateTime?
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt

  // Relations
  tenant          Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client          Client            @relation(fields: [clientId], references: [id])
  createdBy       User              @relation("CreatedOffers", fields: [createdById], references: [id])
  sections        OfferSection[]
  attachments     OfferAttachment[]
  activities      OfferActivity[]
  versions        OfferVersion[]
  paymentSchedule PaymentSchedule[]
  signature       Signature?
  emailLogs       EmailLog[]

  @@unique([tenantId, offerNumber])
  @@index([tenantId])
  @@index([clientId])
  @@index([status])
  @@map("offers")
}

model OfferSection {
  id          String   @id @default(cuid())
  offerId     String
  title       String
  description String?  @db.Text
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  offer    Offer     @relation(fields: [offerId], references: [id], onDelete: Cascade)
  articles Article[]

  @@index([offerId])
  @@map("offer_sections")
}

model Article {
  id              String   @id @default(cuid())
  sectionId       String
  name            String
  description     String?  @db.Text
  unit            String   @default("pcs")
  unitPrice       Decimal  @db.Decimal(12, 2)
  quantity        Decimal  @default(1) @db.Decimal(12, 4)
  vatRate         Decimal  @default(0) @db.Decimal(5, 2)
  discountPercent Decimal  @default(0) @db.Decimal(5, 2)
  discountFixed   Decimal  @default(0) @db.Decimal(12, 2)
  total           Decimal  @default(0) @db.Decimal(12, 2)
  specifications  Json?
  images          String[]
  sortOrder       Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  section OfferSection @relation(fields: [sectionId], references: [id], onDelete: Cascade)

  @@index([sectionId])
  @@map("articles")
}

model ArticleTemplate {
  id             String   @id @default(cuid())
  tenantId       String
  name           String
  description    String?  @db.Text
  unit           String   @default("pcs")
  unitPrice      Decimal  @db.Decimal(12, 2)
  vatRate        Decimal  @default(0) @db.Decimal(5, 2)
  category       String?
  specifications Json?
  images         String[]
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([category])
  @@map("article_templates")
}

model OfferAttachment {
  id        String   @id @default(cuid())
  offerId   String
  name      String
  url       String
  size      Int
  mimeType  String
  createdAt DateTime @default(now())

  // Relations
  offer Offer @relation(fields: [offerId], references: [id], onDelete: Cascade)

  @@index([offerId])
  @@map("offer_attachments")
}

model OfferActivity {
  id        String   @id @default(cuid())
  offerId   String
  type      String
  message   String
  metadata  Json?
  createdAt DateTime @default(now())

  // Relations
  offer Offer @relation(fields: [offerId], references: [id], onDelete: Cascade)

  @@index([offerId])
  @@map("offer_activities")
}

// ===========================================
// TEMPLATES & VERSIONING (PHASE 2)
// ===========================================

model OfferTemplate {
  id          String   @id @default(cuid())
  tenantId    String
  name        String
  description String?
  category    String?
  sections    Json     // Full sections/articles structure
  terms       String?
  validityDays Int     @default(30)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@map("offer_templates")
}

model OfferVersion {
  id        String   @id @default(cuid())
  offerId   String
  version   Int
  data      Json     // Full offer snapshot
  changedBy String
  changeNote String?
  createdAt DateTime @default(now())
  
  offer     Offer    @relation(fields: [offerId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [changedBy], references: [id])

  @@index([offerId])
  @@map("offer_versions")
}

model PaymentSchedule {
  id          String   @id @default(cuid())
  offerId     String
  name        String   // "Deposit", "Milestone 1", "Final Payment"
  percentage  Decimal  @db.Decimal(5, 2) // Percentage of total
  amount      Decimal? @db.Decimal(12, 2) // Or fixed amount
  dueDate     DateTime?
  description String?
  status      String   @default("pending") // pending, invoiced, paid
  order       Int
  createdAt   DateTime @default(now())
  
  offer       Offer    @relation(fields: [offerId], references: [id], onDelete: Cascade)

  @@index([offerId])
  @@map("payment_schedules")
}

model Signature {
  id          String   @id @default(cuid())
  offerId     String   @unique
  signerName  String
  signerEmail String
  signatureData String // Base64 signature image
  ipAddress   String?
  userAgent   String?
  signedAt    DateTime @default(now())
  
  offer       Offer    @relation(fields: [offerId], references: [id], onDelete: Cascade)

  @@map("signatures")
}

model EmailTemplate {
  id        String   @id @default(cuid())
  tenantId  String
  name      String
  subject   String
  body      String   // HTML template with variables
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@map("email_templates")
}

model EmailLog {
  id        String   @id @default(cuid())
  offerId   String
  to        String
  subject   String
  status    String   // sent, delivered, opened, clicked
  sentAt    DateTime @default(now())
  openedAt  DateTime?
  
  offer     Offer    @relation(fields: [offerId], references: [id], onDelete: Cascade)

  @@index([offerId])
  @@map("email_logs")
}

// ===========================================
// NOTIFICATIONS
// ===========================================

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
  OFFER_SENT
  OFFER_VIEWED
  OFFER_ACCEPTED
  OFFER_REJECTED
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  title     String
  message   String
  type      NotificationType @default(INFO)
  isRead    Boolean          @default(false)
  actionUrl String?
  createdAt DateTime         @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@map("notifications")
}
